name: "Copilot Setup Steps"

# Automatically run the setup steps when they are changed to allow for easy validation, and
# allow manual testing through the repository's "Actions" tab
on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  # The job MUST be called `copilot-setup-steps` or it will not be picked up by Copilot.
  copilot-setup-steps:
    runs-on: ubuntu-latest

    # Set the permissions to the lowest permissions possible needed for your steps.
    # Copilot will be given its own token for its operations.
    permissions:
      # Need contents: read to clone the repository and TreeTools for debugging support
      contents: read

    # You can define any steps you want, and they will run before the agent starts.
    # If you do not check out your code, Copilot will do this for you.
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'
          # Include custom repository for TreeTools and TreeDistData packages
          extra-repositories: https://ms609.github.io/packages/

      - name: Install system dependencies (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-latex-base libglpk-dev texlive-fonts-recommended

      - name: Set up essential R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          cache: "always"
          cache-version: 1
          dependencies: '"hard"'
            
      - name: Additional R dependencies
        # Using two steps to circumvent timeout
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          dependencies: '"hard"'
          cache: "always"
          cache-version: 2
          extra-packages: |
            ms609/TreeDistData
            devtools
            testthat
            roxygen2
            lintr
          needs: |
            check

      - name: Checkout TreeTools source (for debugging support)
        uses: actions/checkout@v4
        with:
          repository: ms609/TreeTools
          path: TreeTools-source
          # This provides access to TreeTools source code for agents to inspect
          # when debugging issues in TreeDist that may relate to TreeTools

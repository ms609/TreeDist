# TreeDist R Package Development

TreeDist is an R package providing efficient implementations of functions for the comparison of phylogenetic trees. It includes C++ code for performance, comprehensive testing, benchmarking infrastructure, and extensive CI/CD workflows.
Correctness, speed and user-friendliness are priorities.

Always reference these instructions first and fallback to search or bash commands only when you encounter unexpected information that does not match the info here.

## Working Effectively

### Bootstrap and Development Setup
- Install R and development tools:
  ```bash
  sudo apt update && sudo apt install -y r-base r-base-dev build-essential
  sudo apt install -y libcurl4-openssl-dev libssl-dev libxml2-dev libfontconfig1-dev libharfbuzz-dev libfribidi-dev
  ```
- Install R development packages:
  ```bash
  sudo R -e "install.packages(c('devtools', 'testthat', 'roxygen2', 'lintr'), repos='https://cran.r-project.org/')"
  ```
- Install TreeDist dependencies:
  ```bash
  sudo R -e "install.packages(c('ape', 'bit64', 'lifecycle', 'colorspace', 'fastmatch', 'RCurl', 'R.cache', 'Rdpack', 'stringi', 'PlotTools', 'TreeTools'), repos='https://cran.r-project.org/', dependencies=TRUE)"
  ```

### Building and Checking
- **NEVER CANCEL**: R package builds can take 10-30+ minutes depending on dependencies and system performance. Set timeout to 60+ minutes.
- Build the package:
  ```bash
  R CMD build .
  ```
- **NEVER CANCEL**: Full R CMD check takes 15-45+ minutes. Set timeout to 90+ minutes.
- Check package (full validation):
  ```bash
  R CMD check TreeDist_*.tar.gz
  ```
- Quick check (development, ~2-5 minutes):
  ```bash
  R CMD check --no-build-vignettes --no-manual .
  ```

### Testing
- **NEVER CANCEL**: Test suite has 61+ test files and can take 10-30+ minutes. Set timeout to 60+ minutes.
- Run all tests:
  ```bash
  R -e "devtools::test()"
  ```
- Run tests with testthat directly:
  ```bash
  R -e "testthat::test_dir('tests/testthat')"
  ```
- Run specific test file:
  ```bash
  R -e "testthat::test_file('tests/testthat/test-tree_display.R')"
  ```

### Development Workflow Commands  
- Load package for development:
  ```bash
  R -e "devtools::load_all()"
  ```
- Check code style (~1-2 minutes):
  ```bash
  R -e "lintr::lint_dir('.')"
  ```
- Build documentation:
  ```bash
  R -e "devtools::document()"
  ```
- **NEVER CANCEL**: Build vignettes takes 5-15+ minutes. Set timeout to 30+ minutes.
- Build vignettes:
  ```bash
  R -e "devtools::build_vignettes(install = FALSE)"
  ```

## Validation

**CRITICAL: Always run the full test suite before proposing changes**
  ```bash
  R -e "devtools::test()"
  ```

- Always run R CMD check for complete validation before finalizing changes.
- ALWAYS run the full test suite when modifying C++ code in src/ directory.
- ALWAYS run lintr to ensure code style compliance before committing.
- For performance-critical changes, run benchmarks in benchmark/ directory:
  ```bash
  R -e "source('benchmark/_run_benchmarks.R')"
  ```
- Memory checking is available but optional (takes significant time):
  ```bash
  R -d "valgrind --tool=memcheck --leak-check=full" --vanilla < memcheck/tests.R
  ```

## Validation Scenarios
After making code changes, validate functionality by testing core phylogenetic tree operations:


## Time Expectations & Critical Warnings
- **R startup**: ~0.1 seconds
- **Linting**: 1-3 minutes for full codebase
- **Quick check** (no vignettes/manual): 2-5 minutes  
- **Documentation building**: 2-5 minutes
- **Test suite**: 10-30+ minutes (NEVER CANCEL - set 60+ minute timeout)
- **Full R CMD check**: 15-45+ minutes (NEVER CANCEL - set 90+ minute timeout)
- **Package build**: 10-30+ minutes (NEVER CANCEL - set 60+ minute timeout)
- **Vignette building**: 5-15+ minutes (NEVER CANCEL - set 30+ minute timeout)
- **Benchmarks**: 5-20+ minutes (NEVER CANCEL - set 30+ minute timeout)

## Repository Structure
### Key Directories
- `R/` - R source code (59 R files with 500+ exported functions)
- `src/` - C++ source code requiring compilation (17 C++ files, SystemRequirements: C++17)
- `tests/testthat/` - Test suite (61+ test files)
- `benchmark/` - Performance benchmarking (10+ benchmark files)  
- `man/` - Generated documentation (do not edit manually)
- `vignettes/` - Package tutorials and documentation
- `data/` - Package data files
- `.github/workflows/` - Extensive CI/CD with R-CMD-check, benchmarks, memory checks

### Important Files
- `DESCRIPTION` - Package metadata, dependencies, and system requirements
- `NAMESPACE` - Generated by roxygen2 (do not edit manually)
- `.lintr` - Code style configuration (follows Google R style guide)
- `NEWS.md` - Version history (update for user-facing changes)
- `tests/testthat.R` - Test runner entry point

## Common Tasks
### After Making Changes
1. Load and test changes interactively:
   ```bash
   R -e "devtools::load_all(); # test your changes interactively"
   ```
2. Run linting:
   ```bash  
   R -e "lintr::lint_dir('.')"
   ```
3. Run relevant tests:
   ```bash
   R -e "devtools::test()"
   ```
4. For C++ changes, always run full check:
   ```bash
   R CMD check --no-build-vignettes .
   ```

### Code Style Guidelines
- Follow Google's R style guide
- Use camelCase for variable names, TitleCase for function names  
- Use Oxford ending 'ize' (not 'ise') and UK spelling where applicable
- Document functions with roxygen2 comments
- Include test cases for new functionality

### CI Will Fail If
- R CMD check fails
- Tests fail  
- Code style violations (lintr)
- Missing or inadequate documentation
- Missing test coverage for new code

## Troubleshooting
- If package won't build: check that all system dependencies are installed
- If tests fail after C++ changes: rebuild package completely
- If documentation is missing: run `devtools::document()`
- If benchmarks fail: performance regressions may need investigation
- Memory issues: use valgrind checking for C++ code validation
